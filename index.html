<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
      }

      button {
        font-size: 20pt;
        width: 100%;
        height: 100%;
      }

      #current-number {
        font-size: 20pt;
        text-align: center;
        width: 100%;
      }

      .container {
        display: flex;
        flex-direction: column;
        width: 100%;
        align-items: stretch;
        height: 100vh;
      }

      .row {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: stretch;
        height: 100%;
      }

      .append {
        background: #c1e1c1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div id="accuracy"></div>
        <div id="orientation"></div>
      </div>

      <div class="row">
        <input id="current-number" />
      </div>

      <div class="row">
        <button class="submit" data-direction="L">L</button>
        <button class="submit" data-direction="C">C</button>
        <button class="submit" data-direction="R">R</button>
      </div>

      <div class="row">
        <button class="append" data-number="1">1</button>
        <button class="append" data-number="2">2</button>
        <button class="append" data-number="3">3</button>
      </div>

      <div class="row">
        <button class="append" data-number="4">4</button>
        <button class="append" data-number="5">5</button>
        <button class="append" data-number="6">6</button>
      </div>

      <div class="row">
        <button class="append" data-number="7">7</button>
        <button class="append" data-number="8">8</button>
        <button class="append" data-number="9">9</button>
      </div>

      <div class="row">
        <button id="start-or-pause">Start</button>
        <button class="append" data-number="0">0</button>
        <button id="clear">Clear</button>
      </div>

      <div class="row">
        <button id="file">Done</button>
      </div>
    </div>

    <script>
      const radians = (deg) => (deg * Math.PI) / 180;
      const degrees = (rad) => (rad * 180) / Math.PI;
      const move = (coords, bearing, amountKm) => {
        const radiusOfEarthKm = 6378.1;
        const bearingRadians = radians(bearing);

        const latitudeRadians = radians(currentPosition.latitude);
        const longitudeRadians = radians(currentPosition.longitude);

        const movedLatitudeRadians = Math.asin(
          Math.sin(latitudeRadians) * Math.cos(amountKm / radiusOfEarthKm) +
            Math.cos(latitudeRadians) *
              Math.sin(amountKm / radiusOfEarthKm) *
              Math.cos(bearingRadians)
        );
        const movedLongitudeRadians =
          longitudeRadians +
          Math.atan2(
            Math.sin(bearingRadians) *
              Math.sin(amountKm / radiusOfEarthKm) *
              Math.cos(latitudeRadians),
            Math.cos(amountKm / radiusOfEarthKm) -
              Math.sin(latitudeRadians) * Math.sin(movedLatitudeRadians)
          );

        return {
          latitude: degrees(movedLatitudeRadians),
          longitude: degrees(movedLongitudeRadians),
        };
      };

      const downloadFile = (name, contents) => {
        const file = new Blob([contents], { type: "application/vnd.osm+xml" });

        const link = document.createElement("a");
        const url = URL.createObjectURL(file);
        link.setAttribute("href", url);
        link.setAttribute("download", name);
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const getFormattedDate = () => {
        const now = new Date();

        return (
          now.getUTCFullYear() +
          "-" +
          (now.getUTCMonth() + 1) +
          "-" +
          now.getUTCDate()
        );
      };

      const currentNumber = document.getElementById("current-number");
      const appends = [...document.getElementsByClassName("append")];
      const addresses = [];
      let currentPosition = null;
      let currentOrientation = null;

      appends.forEach((append) => {
        append.addEventListener("click", () => {
          currentNumber.value = currentNumber.value.concat(
            append.dataset.number
          );
        });
      });

      const submits = [...document.getElementsByClassName("submit")];

      submits.forEach((submit) => {
        submit.addEventListener("click", () => {
          if (currentPosition === null) {
            alert("No GPS");
            return;
          }

          if (currentNumber.value === "") {
            alert("No number");
            return;
          }

          let bearing = currentOrientation;
          const direction = submit.dataset.direction;

          if (direction === "L") {
            bearing -= 90;
          }

          if (direction === "R") {
            bearing += 90;
          }

          const newPosition = move(currentPosition, bearing, 0.01);

          addresses.push({
            latitude: newPosition.latitude,
            longitude: newPosition.longitude,
            number: currentNumber.value,
          });

          currentNumber.value = "";
        });
      });

      const startOrPause = document.getElementById("start-or-pause");
      let started = false;
      let watchId;
      const accuracy = document.getElementById("accuracy");

      startOrPause.addEventListener("click", () => {
        if (started) {
          startOrPause.innerText = "Start";
          navigator.geolocation.clearWatch(watchId);
          accuracy.innerText = "not connected";
          started = false;
          return;
        }

        startOrPause.innerText = "Pause";
        started = true;
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            console.log(position);
            accuracy.innerText = String(
              Math.round(position.coords.accuracy)
            ).concat("m");
            currentPosition = position.coords;
          },
          (e) => {
            console.log(e);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
          }
        );
      });

      const file = document.getElementById("file");

      file.addEventListener("click", () => {
        if (addresses.length === 0) {
          alert("No addresses recorded");
          return;
        }

        const xml = document.implementation.createDocument("", "", null);
        const osm = xml.createElement("osm");
        osm.setAttribute("version", "0.6");
        osm.setAttribute("generator", "AddressCollector testing");

        addresses.forEach((address, i) => {
          const node = xml.createElement("node");
          node.setAttribute("id", -1 - i);
          node.setAttribute("version", 1);
          node.setAttribute("lat", address.latitude);
          node.setAttribute("lon", address.longitude);

          const tag = xml.createElement("tag");

          if (isNaN(address.number)) {
            tag.setAttribute("k", "addr:housename");
          } else {
            tag.setAttribute("k", "addr:housenumber");
          }

          tag.setAttribute("v", address.number);

          node.appendChild(tag);
          osm.appendChild(node);
        });

        xml.appendChild(osm);

        const xmlString = new XMLSerializer().serializeToString(xml);

        downloadFile(getFormattedDate().concat(".osm"), xmlString);
      });

      const clear = document.getElementById("clear");

      clear.addEventListener("click", () => {
        currentNumber.value = "";
      });

      const orientation = document.getElementById("orientation");

      window.addEventListener("deviceorientationabsolute", (e) => {
        currentOrientation = e.alpha;
        orientation.innerText = Math.round(e.alpha);
      });
    </script>
  </body>
</html>
