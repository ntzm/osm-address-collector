<!--
Copyright (C) 2022  Nat Zimmermann

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSM Address Collector</title>

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="assets/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="assets/favicon-16x16.png"
    />
    <link rel="manifest" href="assets/site.webmanifest" />
    <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="theme-color" content="#ffffff" />

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        font-family: sans-serif;
        color: #333;
      }

      button {
        font-size: 24pt;
        width: 100%;
        height: 100%;
        border: 1px #999 solid;
        background: #eee;
        color: #333;
        font-weight: bold;
      }

      #current-number-or-name {
        font-size: 24pt;
        text-align: center;
        width: 100%;
        border: 1px #999 solid;
        color: #333;
        font-weight: bold;
        margin: 0;
        border-radius: 0;
        appearance: none;
      }

      #done {
        background: #aec6cf;
      }

      #clear {
        background: #faa0a0;
      }

      .container {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 720px;
        align-items: stretch;
        box-sizing: border-box;
        min-height: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: hidden;
      }

      .row {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: stretch;
        height: 100%;
      }

      .append {
        background: #c1e1c1;
      }

      .info {
        padding: 15px;
        width: 100%;
        text-align: center;
        font-size: 20pt;
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .info-icon {
        width: 32px;
        margin: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="info">
          <img
            class="info-icon"
            src="assets/satellite.svg"
            alt="GPS Accuracy"
          />
          <span id="accuracy">N/A</span>
        </div>
        <div class="info">
          <img class="info-icon" src="assets/compass.svg" alt="Orientation" />
          <span id="orientation">N/A</span>
        </div>
      </div>

      <div class="row">
        <input type="text" id="current-number-or-name" autocapitalize />
      </div>

      <div class="row">
        <button class="submit" data-direction="L">
          <img
            style="width: 50px; transform: rotate(-90deg)"
            src="assets/arrow.svg"
            alt="Left"
          />
        </button>
        <button class="submit" data-direction="C">
          <img style="width: 50px" src="assets/arrow.svg" alt="Forward" />
        </button>
        <button class="submit" data-direction="R">
          <img
            style="width: 50px; transform: rotate(90deg)"
            src="assets/arrow.svg"
            alt="Right"
          />
        </button>
      </div>

      <div class="row">
        <button class="append" data-number="1">1</button>
        <button class="append" data-number="2">2</button>
        <button class="append" data-number="3">3</button>
      </div>

      <div class="row">
        <button class="append" data-number="4">4</button>
        <button class="append" data-number="5">5</button>
        <button class="append" data-number="6">6</button>
      </div>

      <div class="row">
        <button class="append" data-number="7">7</button>
        <button class="append" data-number="8">8</button>
        <button class="append" data-number="9">9</button>
      </div>

      <div class="row">
        <button id="start-or-pause">Start</button>
        <button class="append" data-number="0">0</button>
        <button id="clear">Clear</button>
      </div>

      <div class="row">
        <button id="done">Done</button>
      </div>
    </div>

    <script>
      const radians = (deg) => (deg * Math.PI) / 180;
      const degrees = (rad) => (rad * 180) / Math.PI;
      const move = (coords, bearing, amountKm) => {
        const radiusOfEarthKm = 6378.1;
        const bearingRadians = radians(bearing);

        const latitudeRadians = radians(currentPosition.latitude);
        const longitudeRadians = radians(currentPosition.longitude);

        const movedLatitudeRadians = Math.asin(
          Math.sin(latitudeRadians) * Math.cos(amountKm / radiusOfEarthKm) +
            Math.cos(latitudeRadians) *
              Math.sin(amountKm / radiusOfEarthKm) *
              Math.cos(bearingRadians)
        );
        const movedLongitudeRadians =
          longitudeRadians +
          Math.atan2(
            Math.sin(bearingRadians) *
              Math.sin(amountKm / radiusOfEarthKm) *
              Math.cos(latitudeRadians),
            Math.cos(amountKm / radiusOfEarthKm) -
              Math.sin(latitudeRadians) * Math.sin(movedLatitudeRadians)
          );

        return {
          latitude: degrees(movedLatitudeRadians),
          longitude: degrees(movedLongitudeRadians),
        };
      };

      const downloadFile = (name, contents, type) => {
        const file = new Blob([contents], { type });

        const link = document.createElement("a");
        const url = URL.createObjectURL(file);
        link.setAttribute("href", url);
        link.setAttribute("download", name);
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const getFormattedDate = () => {
        const now = new Date();

        return [
          now.getFullYear(),
          "-",
          now.getMonth() + 1,
          "-",
          now.getDate(),
          "-",
          now.getHours(),
          now.getMinutes(),
          now.getSeconds(),
        ].join("");
      };

      const currentNumberOrName = document.getElementById(
        "current-number-or-name"
      );
      const appends = [...document.getElementsByClassName("append")];
      const addresses = [];
      let currentPosition = null;
      let currentOrientation = null;

      appends.forEach((append) => {
        append.addEventListener("click", () => {
          currentNumberOrName.value = currentNumberOrName.value.concat(
            append.dataset.number
          );
        });
      });

      const submits = [...document.getElementsByClassName("submit")];

      submits.forEach((submit) => {
        submit.addEventListener("click", () => {
          if (currentPosition === null) {
            alert("No GPS");
            return;
          }

          if (currentNumberOrName.value === "") {
            alert("No number or name");
            return;
          }

          let bearing = currentOrientation;
          const direction = submit.dataset.direction;

          if (direction === "L") {
            bearing -= 90;
          }

          if (direction === "R") {
            bearing += 90;
          }

          const newPosition = move(currentPosition, bearing, 0.01);

          addresses.push({
            latitude: newPosition.latitude,
            longitude: newPosition.longitude,
            numberOrName: currentNumberOrName.value,
          });

          currentNumberOrName.value = "";
        });
      });

      const startOrPause = document.getElementById("start-or-pause");
      let started = false;
      let watchId;
      const accuracy = document.getElementById("accuracy");

      startOrPause.addEventListener("click", () => {
        if (started) {
          startOrPause.innerText = "Start";
          navigator.geolocation.clearWatch(watchId);
          accuracy.innerText = "N/A";
          accuracy.style.color = "#333";
          started = false;
          return;
        }

        startOrPause.innerText = "Starting";

        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const acc = Math.round(position.coords.accuracy);
            accuracy.innerText = String(acc).concat("m");

            startOrPause.innerText = "Pause";
            started = true;

            if (acc < 10) {
              accuracy.style.color = "#c1e1c1";
            } else if (acc < 20) {
              accuracy.style.color = "#ffb347";
            } else {
              accuracy.style.color = "#ff6961";
            }

            currentPosition = position.coords;
          },
          (e) => {
            startOrPause.innerText = "Start";

            if (e.code === e.PERMISSION_DENIED) {
              alert("GPS permission denied: " + e.message);
              return;
            }

            if (e.code === e.POSITION_UNAVAILABLE) {
              alert("GPS permission unavailable: " + e.message);
              return;
            }

            if (e.code === e.TIMEOUT) {
              alert("GPS position timeout: " + e.message);
              return;
            }
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
          }
        );
      });

      const done = document.getElementById("done");

      done.addEventListener("click", () => {
        if (addresses.length === 0) {
          alert("No addresses recorded");
          return;
        }

        const xml = document.implementation.createDocument("", "", null);
        const osm = xml.createElement("osm");
        osm.setAttribute("version", "0.6");
        osm.setAttribute("generator", "AddressCollector testing");

        addresses.forEach((address, i) => {
          const node = xml.createElement("node");
          node.setAttribute("id", -1 - i);
          node.setAttribute("version", 1);
          node.setAttribute("lat", address.latitude);
          node.setAttribute("lon", address.longitude);

          const tag = xml.createElement("tag");

          if (isNaN(address.numberOrName)) {
            tag.setAttribute("k", "addr:housename");
          } else {
            tag.setAttribute("k", "addr:housenumber");
          }

          tag.setAttribute("v", address.numberOrName);

          node.appendChild(tag);
          osm.appendChild(node);
        });

        xml.appendChild(osm);

        const xmlString = new XMLSerializer().serializeToString(xml);

        downloadFile(
          getFormattedDate().concat(".osm"),
          xmlString,
          "application/vnd.osm+xml"
        );
      });

      const clear = document.getElementById("clear");

      clear.addEventListener("click", () => {
        currentNumberOrName.value = "";
      });

      const orientation = document.getElementById("orientation");

      const updateOrientation = (o) => {
        currentOrientation = o;
        orientation.innerText = Math.round(o) + "°";
      };

      window.addEventListener("deviceorientationabsolute", (e) => {
        updateOrientation(e.alpha);
      });

      const maybeAbsoluteDeviceOrientationHandler = (e) => {
        if (e.webkitCompassHeading) {
          updateOrientation(e.webkitCompassHeading);
          return;
        }

        if (e.absolute) {
          updateOrientation(e.alpha);
          return;
        }

        window.removeEventListener(
          "deviceorientation",
          maybeAbsoluteDeviceOrientationHandler
        );
      };

      window.addEventListener(
        "deviceorientation",
        maybeAbsoluteDeviceOrientationHandler
      );
    </script>
  </body>
</html>
